<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2019-12-02 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20191202" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Eiffel Intelligence &#x2013; Step By Step Subscription Notification</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

          
                      </head>
        <body class="topBarEnabled">
          
                
                    
                

    <div id="topbar" class="navbar navbar-fixed-top navbar-inverse">
      <div class="navbar-inner">
                <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
                
                                                                                                    <a class="brand" href="./" >

                                
                                    Eiffel Intelligence
                
                </a>
                    
                                <ul class="nav">
                          <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="index.html"  title="Home">Home</a>
</li>
                  
                      <li class="dropdown-submenu">
                                      <a href="running-eiffel-intelligence.html"  title="Running Eiffel Intelligence">Running Eiffel Intelligence</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="configuration.html"  title="Configuration">Configuration</a>
</li>
                                  <li>      <a href="docker.html"  title="Running in Docker">Running in Docker</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="subscriptions.html"  title="Understanding subscriptions">Understanding subscriptions</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="subscription-with-REST-POST-notification.html"  title="Subscription with REST POST notification">Subscription with REST POST notification</a>
</li>
                                  <li>      <a href="triggering-jenkins-jobs.html"  title="HTTP POST notification to trigger parameterized Jenkins jobs">HTTP POST notification to trigger parameterized Jenkins jobs</a>
</li>
                                  <li>      <a href="subscription-with-email-notification.html"  title="Subscription with Email notification">Subscription with Email notification</a>
</li>
                                  <li>      <a href="step-by-step-subscription-notification.html"  title="Step-by-step Subscription Notification">Step-by-step Subscription Notification</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="rules.html"  title="Understanding rules">Understanding rules</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="merge-resolver-rules.html"  title="Merge Resolver Rules">Merge Resolver Rules</a>
</li>
                                  <li>      <a href="history-rules.html"  title="History Rules">History Rules</a>
</li>
                                  <li>      <a href="example-rules.html"  title="Example Rules">Example Rules</a>
</li>
                                  <li>      <a href="mapping-rules-to-aggregations.html"  title="Mapping Rules To Aggregations">Mapping Rules To Aggregations</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="step-by-step-aggregation.html"  title="Step-by-step aggregation">Step-by-step aggregation</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="artifact-created-event-aggregation.html"  title="ArtifactCreatedEvent aggregation">ArtifactCreatedEvent aggregation</a>
</li>
                                  <li>      <a href="test-case-triggered-event-aggregation.html"  title="TestCaseTriggeredEvent aggregation">TestCaseTriggeredEvent aggregation</a>
</li>
                                  <li>      <a href="test-case-started-event-aggregation.html"  title="TestCaseStartedEvent aggregation">TestCaseStartedEvent aggregation</a>
</li>
                                  <li>      <a href="test-case-finished-event-aggregation.html"  title="TestCaseFinishedEvent aggregation">TestCaseFinishedEvent aggregation</a>
</li>
                                  <li>      <a href="artifact-published-event-aggregation.html"  title="ArtifactPublishedEvent aggregation">ArtifactPublishedEvent aggregation</a>
</li>
                                  <li>      <a href="confidence-level-modified-event-aggregation.html"  title="ConfidenceLevelModifiedEvent">ConfidenceLevelModifiedEvent</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="REST-API.html"  title="REST API">REST API</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="query.html"  title="Query">Query</a>
</li>
                                  <li>      <a href="failed-notifications.html"  title="Failed notifications">Failed notifications</a>
</li>
                                  <li>      <a href="running-rules-on-objects.html"  title="Running rules on objects">Running rules on objects</a>
</li>
                                  <li>      <a href="authentication.html"  title="Authentication">Authentication</a>
</li>
                                  <li>      <a href="subscription-API.html"  title="Subscriptions">Subscriptions</a>
</li>
                                  <li>      <a href="status.html"  title="Status">Status</a>
</li>
                                  <li>      <a href="templates.html"  title="Get templates">Get templates</a>
</li>
                              </ul>
            </li>
                  
                      <li>      <a href="compatibility.html"  title="Compatibility">Compatibility</a>
</li>
                  
                      <li>      <a href="known-limitations.html"  title="Known limitations">Known limitations</a>
</li>
                          </ul>
      </li>
                  </ul>
          
          
          
                   
                      </div>
          
        </div>
      </div>
    </div>
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Eiffel Intelligence</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                              <li class="">
                    <a href="index.html" title="Home">
        Home</a>
                    <span class="divider">-</span>
      </li>
        <li class="active ">Step By Step Subscription Notification</li>
        
              
                  <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2019-12-02</li>
              <li id="projectVersion" class="pull-right">
                    Version: 2.0.0
        </li>
            
                            </ul>
      </div>

                  
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                              
      <li>
  
                          <a href="index.html" title="Home">
          <span class="none"></span>
        Home</a>
            </li>
                                                                                    
      <li>
  
                          <a href="running-eiffel-intelligence.html" title="Running Eiffel Intelligence">
          <span class="icon-chevron-right"></span>
        Running Eiffel Intelligence</a>
                  </li>
                                                                                                                                  
      <li>
  
                          <a href="subscriptions.html" title="Understanding subscriptions">
          <span class="icon-chevron-down"></span>
        Understanding subscriptions</a>
                    <ul class="nav nav-list">
                    
      <li>
  
                          <a href="subscription-with-REST-POST-notification.html" title="Subscription with REST POST notification">
          <span class="none"></span>
        Subscription with REST POST notification</a>
            </li>
                    
      <li>
  
                          <a href="triggering-jenkins-jobs.html" title="HTTP POST notification to trigger parameterized Jenkins jobs">
          <span class="none"></span>
        HTTP POST notification to trigger parameterized Jenkins jobs</a>
            </li>
                    
      <li>
  
                          <a href="subscription-with-email-notification.html" title="Subscription with Email notification">
          <span class="none"></span>
        Subscription with Email notification</a>
            </li>
                    
      <li class="active">
  
            <a href="#"><span class="none"></span>Step-by-step Subscription Notification</a>
          </li>
              </ul>
        </li>
                                                                                                                        
      <li>
  
                          <a href="rules.html" title="Understanding rules">
          <span class="icon-chevron-right"></span>
        Understanding rules</a>
                  </li>
                                                                                                                                                            
      <li>
  
                          <a href="step-by-step-aggregation.html" title="Step-by-step aggregation">
          <span class="icon-chevron-right"></span>
        Step-by-step aggregation</a>
                  </li>
                                                                                                                                                                              
      <li>
  
                          <a href="REST-API.html" title="REST API">
          <span class="icon-chevron-right"></span>
        REST API</a>
                  </li>
                
      <li>
  
                          <a href="compatibility.html" title="Compatibility">
          <span class="none"></span>
        Compatibility</a>
            </li>
                
      <li>
  
                          <a href="known-limitations.html" title="Known limitations">
          <span class="none"></span>
        Known limitations</a>
            </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                        
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Step By Step Subscription Notification</h1>
<p>Suppose a subscription is created (as shown below) by a user and then that is stored in the subscription database. Read more about the <a class="externalLink" href="https://github.com/eiffel-community/eiffel-intelligence/blob/master/wiki/markdown/subscription-API.md">subscription REST API</a> and <a class="externalLink" href="https://github.com/eiffel-community/eiffel-intelligence-frontend/blob/master/wiki/markdown/add-subscription.md">adding subscriptions via Eiffel Intelligence frontend GUI</a>.</p>

<div>
<div>
<pre class="source">{
    &quot;created&quot;: &quot;2017-07-26&quot;,
    &quot;notificationMeta&quot;: &quot;http://127.0.0.1:3000/api/send&quot;,
    &quot;notificationType&quot;: &quot;REST_POST&quot;,
    &quot;restPostBodyMediaType&quot;: &quot;application/x-www-form-urlencoded&quot;,
    &quot;notificationMessageKeyValues&quot;: [{
        &quot;formkey&quot;: &quot;data&quot;,
        &quot;formvalue&quot;: &quot;{parameters: [{ name: 'jsonparams', value : to_string(@) }, { name: 'artifact_identity', value : @.identity }]}&quot;
    }],
    &quot;repeat&quot;: false,
    &quot;requirements&quot;: [{
            &quot;conditions&quot;: [{
                    &quot;jmespath&quot;: &quot;identity=='pkg:maven/com.mycompany.myproduct/sub-system@1.1.0'&quot;
                },
                {
                    &quot;jmespath&quot;: &quot;testCaseExecutions[?testCase.conclusion == 'SUCCESSFUL' &amp;&amp; testCase.id=='TC5']&quot;
                }
            ],
        },
        {
            &quot;conditions&quot;: [{
                    &quot;jmespath&quot;: &quot;identity=='pkg:maven/com.mycompany.myproduct/sub-system@1.1.0'&quot;
                },
                {
                    &quot;jmespath&quot;: &quot;testCaseExecutions[?testCaseStartedEventId == '13af4a14-f951-4346-a1ba-624c79f10e98']&quot;
                }
            ],
        }
    ],
    &quot;subscriptionName&quot;: &quot;Subscription_Test&quot;,
    &quot;userName&quot;: &quot;ABC&quot;
}
</pre></div></div>

<p>In this subscription, two requirements are given, where each requirement in turn contains two conditions. As per subscription logic, when all the conditions in any one of the given requirements are met in an aggregated object then the subscription is fulfilled. This means that the subscriber will be notified with the chosen notification method. It should be noted that conditions are given as JMESPath expression. Let us suppose that an aggregated object, as shown below, is created:</p>

<div>
<div>
<pre class="source">{
    &quot;fileInformation&quot;: [{
        &quot;extension&quot;: &quot;jar&quot;,
        &quot;classifier&quot;: &quot;&quot;
    }],
    &quot;buildCommand&quot;: null,
    &quot;testCaseExecutions&quot;: [{
        &quot;testCaseFinishEventId&quot;: &quot;11109351-41e0-474a-bc1c-f6e81e58a1c9&quot;,
        &quot;testCaseStartedTime&quot;: 1481875925916,
        &quot;testCaseStartedEventId&quot;: &quot;cb9d64b0-a6e9-4419-8b5d-a650c27c59ca&quot;,
        &quot;testCaseFinishedTime&quot;: 1481875935919,
        &quot;testCase&quot;: {
            &quot;conclusion&quot;: &quot;SUCCESSFUL&quot;,
            &quot;verdict&quot;: &quot;PASSED&quot;,
            &quot;tracker&quot;: &quot;My Other Test Management System&quot;,
            &quot;id&quot;: &quot;TC5&quot;,
            &quot;uri&quot;: &quot;https://other-tm.company.com/testCase/TC5&quot;
        }
    }],
    &quot;id&quot;: &quot;6acc3c87-75e0-4b6d-88f5-b1a5d4e62b43&quot;,
    &quot;time&quot;: 1481875891763,
    &quot;type&quot;: &quot;ARTIFACT_1&quot;,
    &quot;identity&quot;: &quot;pkg:maven/com.mycompany.myproduct/sub-system@1.1.0&quot;
}
</pre></div></div>

<p>When this aggregated object is evaluated against the subscriptions stored in the database, then it fulfills our subscription criteria. It can be seen that both conditions of the first requirement are satisfied by this aggregated object. More specifically, in the first condition, JMESPath rule is looking for:</p>

<div>
<div>
<pre class="source">identity=='pkg:maven/com.mycompany.myproduct/sub-system@1.1.0'
</pre></div></div>

<p>and in the second condition it looks for</p>

<div>
<div>
<pre class="source">testCaseExecutions.testCase.conclusion == 'SUCCESSFUL' &amp;&amp; testCase.id=='TC5'
</pre></div></div>

<p>Both strings can be found in the aggregated object JSON. Consequently, the process is started to send notification to the specified subscriber. For this, &#x2018;notificationMeta&#x2019; and &#x2018;notificationType&#x2019; field values are extracted from the subscription.</p>
<div class="section">
<h2><a name="Notify_via_REST_POST"></a>Notify via REST POST</h2>
<p>In the example subscription above, the notification is sent as <b>REST POST</b> to the url <tt>http://127.0.0.1:3000/ei/test_subscription_rest</tt>. The notification message in this subscription is prepared as key value pairs in the request body.</p>

<div>
<div>
<pre class="source">&quot;notificationMessageKeyValues&quot;: [{
    &quot;formkey&quot;: &quot;data&quot;,
    &quot;formvalue&quot;: &quot;{parameters: [{ name: 'jsonparams', value : to_string(@) }, { name: 'artifact_identity', value : @.identity }]}&quot;
}]
</pre></div></div>

<p>The key is &#x2018;jsonparams&#x2019; and the value is the full aggregated object. The second parameter is the artifact identity which is extracted from the aggregation, These are part of the notification message for this particular subscription. Below is a list of the parameters defined in the above notification message which will be sent for this subscription.</p>

<div>
<div>
<pre class="source">parameters:
    jsonparams: {full aggregated object}
    artifact_identity: pkg:maven/com.mycompany.myproduct/sub-system@1.1.0
</pre></div></div>

<p>If it was sent as raw JSON body, the first parameter of the notification message would look like below:</p>

<div>
<div>
<pre class="source">{
    [
        {
            &quot;fileInformation&quot;: [{
                &quot;extension&quot;: &quot;jar&quot;,
                &quot;classifier&quot;: &quot;&quot;
            }],
            &quot;buildCommand&quot;: null,
            &quot;testCaseExecutions&quot;: [{
                &quot;testCaseFinishEventId&quot;: &quot;11109351-41e0-474a-bc1c-f6e81e58a1c9&quot;,
                &quot;testCaseStartedTime&quot;: 1481875925916,
                &quot;testCaseStartedEventId&quot;: &quot;cb9d64b0-a6e9-4419-8b5d-a650c27c59ca&quot;,
                &quot;testCaseFinishedTime&quot;: 1481875935919,
                &quot;testCase&quot;: {
                    &quot;conclusion&quot;: &quot;SUCCESSFUL&quot;,
                    &quot;verdict&quot;: &quot;PASSED&quot;,
                    &quot;tracker&quot;: &quot;My Other Test Management System&quot;,
                    &quot;id&quot;: &quot;TC5&quot;,
                    &quot;uri&quot;: &quot;https://other-tm.company.com/testCase/TC5&quot;
                }
            }],
            &quot;id&quot;: &quot;6acc3c87-75e0-4b6d-88f5-b1a5d4e62b43&quot;,
            &quot;time&quot;: 1481875891763,
            &quot;type&quot;: &quot;ARTIFACT_1&quot;,
            &quot;identity&quot;: &quot;pkg:maven/com.mycompany.myproduct/sub-system@1.1.0&quot;
        }
    ]
}
</pre></div></div>
</div>
<div class="section">
<h2><a name="Notify_via_MAIL"></a>Notify via MAIL</h2>
<p>If the &#x201c;notificationType&#x201d; of the subscription is &#x201c;MAIL&#x201d; then the notification message is sent to the email address(es) specified in the &#x201c;notificationMeta&#x201d; field. If more than one email address is written, it should be written as a comma separated string. The subject for the email can be set globally (same for all subscriptions) in application.properties as &#x201c;email.subject&#x201d;. It can also be set for individual subscriptions using the Eiffel Intelligence front-end GUI.</p>
<p>As with the conditions, it is also possible to write JMESPath expressions for the notification message. If we use the example subscription above, the notification could be to send data extracted from the aggregated object. We could for example use the below JMESPath expression in the subscription notification message:</p>

<div>
<div>
<pre class="source">&quot;{parameters: [{ name: 'artifactIdentity', value : to_string(@.identity) }, { name: 'testCase', value: to_string(@.testCaseExecutions[0].testCase.id) }]}&quot;
</pre></div></div>

<p>This expression selects the field identity from the aggregated object and this is used as value for the parameter &#x201c;artifactIdentity&#x201d;. The second parameter is also extracted from the aggregation and results in a string value of the testcase id. The complete notification message can be seen below:</p>

<div>
<div>
<pre class="source">parameters:
    artifactIdentity: pkg:maven/com.mycompany.myproduct/sub-system@1.1.0
    testCase: TC5
</pre></div></div>
</div>
<div class="section">
<h2><a name="Failed_notifications"></a>Failed notifications</h2>
<p>If the notification via REST POST fails, then a fixed number of attempts are made to resend successfully. The number of attempts are specified in the <a class="externalLink" href="https://github.com/eiffel-community/eiffel-intelligence/blob/master/src/main/resources/application.properties">application.properties</a> as &#x201c;notification.failAttempt&#x201d;. If message sending attempts fails for the specified number of time, then a failed notification is prepared and stored in the database. The name of the collection is specified in the application.properties file as &#x201c;failed.notification.collection-name&#x201d;. The message is stored in the database for a certain duration before being deleted. This time can be configured in application.properties as &#x201c;notification.ttl.value&#x201d;.</p>
<p><b>Failed notification in the failed notification database with TTL value:</b></p>

<div>
<div>
<pre class="source">[
    {
        &quot;subscriptionName&quot;: &quot;Sub1&quot;,
        &quot;aggregatedObject&quot;: { full aggregation at the time of notification attempt },
        &quot;notificationMeta&quot;: &quot;http://localhost:9999/some-endpoint&quot;,
        &quot;_id&quot;: {
            &quot;$oid&quot;: &quot;5d807a1d821b960af311fab3&quot;
        },
        &quot;time&quot;: {
            &quot;$date&quot;: &quot;2020-10-17T06:15:57.000Z&quot;
        },
        &quot;message&quot;: &quot;Failed to send REST/POST notification!\nMessage: I/O error on POST request for \&quot;http://localhost:9999/some-endpoint\&quot;: Connect to localhost:9999 [localhost/127.0.0.1] failed: Connection refused (Connection refused); nested exception is org.apache.http.conn.HttpHostConnectException: Connect to localhost:9999 [localhost/127.0.0.1] failed: Connection refused (Connection refused)&quot;
    }
]
</pre></div></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                          
                </div>

        
                </div>
    </footer>
        </body>
</html>
